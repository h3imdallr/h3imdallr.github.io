---
layout:     post
published: True
title:      "Anomaly Detection"
subtitle:   "time series anomaly detection"
date:   2016-12-23 14:34:25
author:     "h3imdallr"
categories: data_science
tags: data_science, anomaly_detection
header-img: ""
---


#### abstract
- _ì´ìƒíƒì§€ì˜ ê¸°ì´ˆì ì¸ ê°œë…, ì‹œê³„ì—´ ë°ì´í„°ì˜ ê¸°ë³¸ì  ì´í•´, ì´ë¥¼ í†µí•œ ì‹œê³„ì—´ ì´ìƒíƒì§€ ë°©ë²• ì†Œê°œ_
- _code/ipynb provided (github link)_

#### reference
- [Statistical Learning Based Anomaly Detection @Twitter](http://www.slideshare.net/arunkejariwal/statistical-learning-based-anomaly-detection-twitter)
- [Anomaly Detection Twitter Github](https://github.com/twitter/AnomalyDetection)
- [Twitter's Blog on Anomaly Detection ](https://blog.twitter.com/2015/introducing-practical-and-robust-anomaly-detection-in-a-time-series)

#### Anomaly Definition:
ê¸°ì¡´ ê´€ì¸¡ê³¼ëŠ” ìƒì´í•˜ì—¬ ë‹¤ë¥¸ ë§¤ì»¤ë‹ˆì¦˜ì— ì˜í•´ ìƒì„±ë˜ì—ˆë‹¤ê³  íŒë‹¨í• ë§Œí•œ ê´€ì¸¡ê°’. (An anomaly is an observation that deviates so much from other observations so as to arouse suspicious that it is was generated by different mechanism.)

#### Approaches on Anomaly Detection:

Anomaly Detection ì€ ê·¸ ìì²´ê°€ ì•Œê³ ë¦¬ì¦˜ì´ë¼ê¸° ë³´ë‹¤ëŠ” â€˜ëª©í‘œí•˜ëŠ”ë°”/ê¸°ëŒ€í•˜ëŠ” ê²°ê³¼â€™ì— í•´ë‹¹í•˜ë©°, ì—¬ëŸ¬ ì•Œê³ ë¦¬ì¦˜ê³¼ ë¶„ì„ë¡ ì„ í™œìš©í•œ â€˜ë¶„ì„ applicationâ€™ ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ, í•´ê²°í•˜ê³ ì í•˜ëŠ” ë¬¸ì œì˜ ëª©ì ê³¼ ì»¨í…ìŠ¤íŠ¸ì— ë”°ë¼ ì´ìƒíƒì§€ ëª©ì ì€ ìƒì´í•´ ì§ˆ ìˆ˜ ìˆë‹¤.   
ì´ìƒíƒì§€ì˜ ë¬¸ì œ íŠ¹ì§•(Problem Characteristics) íŒŒì•… ë° êµ¬ì²´ì  ë¶„ì„ë°©ë²•ë¡  ìˆ˜ë¦½ì‹œ ê³ ë ¤í•  ì‚¬í•­ë“¤ì€ ì•„ë˜ì™€ ê°™ë‹¤.

(1) ëª©ì (Objectives)  

- ê¸°íšŒ íƒì§€ Chance discovery (Positive anomaly)
- ì˜¤ë¥˜ íƒì§€ Fault Discovery (Negative Anomaly)
- ìƒˆë¡œì›€ì˜ íƒì§€ Novelty Detection
- ë…¸ì´ì¦ˆ ì œê±° Noise Removal

(2) ì…ë ¥ ë°ì´í„°ì˜ íŠ¹ì„±(Nature of input data)  

- ì‹œê³„ì—´ Time-Series(sequential) vs Static
- ë‹¨ë³€ëŸ‰/ë‹¤ë³€ëŸ‰ Univariate vs Multivariate
- ë°ì´í„° íƒ€ì… Data Type (Binary /Categorical /Continuous /Hybrid)
- ìƒí˜¸ì˜ì¡´ì /ë…ë¦½ì  Relational vs Independent
- (ê¸°ì¡´ ë£°ì˜ ì ìš©ì´ ê°€ëŠ¥í•  ë§Œí¼) ì˜ ì•Œë ¤ì§„/ì•Œë ¤ì ¸ ìˆì§€ ì•Šì€ Well-known or not (rule existing or not)

(3) ì´ìƒê°’ì˜ ì¢…ë¥˜(Type of anomaly)  

ì´ìƒê°’ì˜ ì¢…ë¥˜ëŠ” ë³´ëŠ” ì‹œê°„ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ì—„ë°€í•œ ê·œì •ì„ í•˜ê¸´ ì–´ë µë‹¤.  
ë¯¸ë„¤ì†Œíƒ€ ëŒ€í•™ì˜ Survey paperì—ëŠ” ì•„ë˜ì™€ ê°™ì´ ê·œì •í•˜ê³  ìˆë‹¤. (source: <Anomaly Detection: A Survey>, 2009, Varun Chandola)

![taxonomy of anomaly detection](/figure-post/20161123-taxonomy.png)

ìœ„ì˜ ë¶„ë¥˜ë¥¼ ìµœëŒ€í•œ ê°„ì†Œí™” ì‹œí‚¤ë©´, ê²°êµ­ ì¶•ì ëœ ì‹œê°„ë™ì•ˆ ì •ì ì¸ ì ë¶„í¬ì— ì´ˆì ì„ ë§ì¶”ëŠ” Point anomaly ì™€, ì‹œê³„ì—´ì ì¸ ë™ì ì¸ íŠ¹ì„±ì— ì£¼ì•ˆì„ ë‘ëŠ” Context anomalyë¡œ êµ¬ë¶„ ì§€ì„ìˆ˜ ìˆë‹¤.

| ë¶„ë¥˜  | íŠ¹ì§•
| :------------ | :-----------: |
| Point anomaly   | Statistics(Gaussian distribution) , Clustering, Classification         
| Contextual anomaly  | Statistics(Gaussian Process Regression, S-H-ESD ...) |  



ì•ì„œ ë°í˜”ë“¯, ì´ëŠ” êµ‰ì¥íˆ ë‹¨ìˆœí™” ì‹œí‚¨ êµ¬ë¶„ì´ê³ , ê²°êµ­ ì´ìƒíƒì§€ë¥¼ ìœ„í•´ì„  'ì •ìƒ ìƒíƒœ'ë¥¼ ê·œì •í•´ì•¼í•˜ê³ , ì´ëŠ” ë‹¹ë©´í•œ ê³¼ì œ, ë„ë©”ì¸ íŠ¹ì„±ì— ë”°ë¼ ìƒì´í•˜ê²Œ ë‹¬ë¼ì§„ë‹¤. ì•„ë˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì´ìƒíƒì§€ê°€ ë¶„ì„ ë  ìˆ˜ ìˆìŒì„ ë‚´í¬í•œë‹¤.

![schema](/figure-post/20161123-schema.png)

### Contextual Anomaly ë¶„ì„ ë°©ë²•ì˜ ì´í•´


#### A. ì‹œê³„ì—´ ë°ì´í„° ì´í•´

ë³¸ ê¸€ì—ì„œ ì†Œê°œí•˜ëŠ” ì´ìƒíƒì§€ ê¸°ë²•(S-H-ESD)ì˜ ì´í•´ë¥¼ ìœ„í•´ì„œëŠ” ì‹œê³„ì—´ íŒ¨í„´ ìš”ì†Œì˜ ì„ í–‰ì  ì´í•´ê°€ ìš”êµ¬ëœë‹¤.  
![TSpattern](/figure-post/20161123-TS_pattern.png)

- ì¶”ì„¸(Trend): ì¥ê¸°ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” ë³€ë™ íŒ¨í„´
- ê³„ì ˆì„±(Seasonal): ì£¼,ì›”,ë¶„ê¸°,ë°˜ê¸° ë‹¨ìœ„ ë“± ì´ë¯¸ ì•Œë ¤ì§„ ì‹œê°„ì˜ ì£¼ê¸°ë¡œ ë‚˜íƒ€ë‚˜ëŠ” íŒ¨í„´
- ì£¼ê¸°(Cyclic): ìµœì†Œ 2 ë…„ ë‹¨ìœ„ë¡œ ë‚˜íƒ€ë‚˜ëŠ” ê³ ì •ëœ ê¸°ê°„ì´ ì•„ë‹Œ ì¥ê¸°ì ì¸ ë³€ë™
- ëœë¤ìš”ì†Œ/ì”ì°¨ (Random/Residual/Remainder): ê·¸ ì´ì™¸ì˜ ì„±ë¶„

#### B. S-H-ESD ê¸°ë²•ì˜ ì´í•´

SNS ì„œë¹„ìŠ¤ì¸ íŠ¸ìœ„í„°ëŠ” ê¸°ì¡´ì˜ í†µê³„ì  ë°©ë²•ë“¤ì„ ì¡°í•©í•˜ì—¬ ì‹œê³„ì—´ì˜ ì´ìƒê°’ì„ íƒì§€í•˜ëŠ” ë°©ë²•ì„ ì œì•ˆí•œë‹¤. (S-H-ESD)
ê°„ëµíˆ ìš”ì•½í•˜ë©´, ì•„ë˜ì™€ ê°™ì´ ê¸°ì¡´ ë°©ë²•ì˜ ë¬¸ì œì— ëŒ€ì‘í•˜ëŠ” ìƒˆë¡œìš´ ë°©ë²•ì„ ì œì•ˆí•œë‹¤.

| **ê¸°ì¡´ ì´ìƒíƒì§€ ë°©ë²•ì˜ í•œê³„**  |
| :------------ |
| 1. ì˜ëª»ëœ ê³„ì‚° ì§€í‘œ (Using Wrong Metric): ê¸°ì¡´ì˜ ë‹¨ìˆœ í‰ê· $\mu$, í‘œì¤€í¸ì°¨$\sigma$ë¥¼ ì´ìš©í•˜ëŠ” ë°©ì‹ ìì²´ê°€ outlierë¥¼ í¬ê´„í•˜ì—¬ ê³„ì‚°í•˜ë¯€ë¡œ ì´ìƒê°’ì— ì·¨ì•½   |
| 2. Multi-modalityì— ì·¨ì•½: í‰ê·œê³¼ í‘œì¤€í¸ì°¨ê°€ seasonality, trend ë“±ì— ì˜í•´ ë³€í™”ë˜ì–´ outlierë¥¼ ë†“ì¹˜ê²Œ ë˜ëŠ” ê²½ìš°ê°€ ë°œìƒ|


| **S-H-ESD ê¸°ë²•ì˜ ì´ìƒíƒì§€ ë°©ë²•** |
| :------------ |
| 1. Use Robust Statistics/Metric: <br/> &nbsp; a. Median Absolute Deviation(MAD) <br/>&nbsp; b. Grubbâ€™s Test& Generalized Extreme Studentized Deviate (ESD)|
| 2. Remove impact of seasonality and trend (Multi-modality aware): <br/> &nbsp; a. Seasonal Trend decomposition using Loess(STL) |



ìœ„ í‘œì—ì„œ ë°íŒ S-H-ESD ê¸°ë²•ì„ ì¢€ë” ìì„¸íˆ ì´í•´í•˜ë ¤ë©´, ë‹¤ìŒê³¼ ê°™ì€ í†µê³„í•™ì  ê°œë…ë“¤ì˜ ì´í•´ê°€ ìš”êµ¬ëœë‹¤.


* Median Absolute Deviation(MAD)
* Student t-distribution
* Extreme Studentized Deviate (ESD) test
* Generalized ESD
* Seasonal Trend decomposition using Loess(STL)


**Median Absolute Deviation(MAD)** - ì¤‘ìœ„ìˆ˜(ì¤‘ì•™ê°’) ì ˆëŒ€ í¸ì°¨ :   
ì¤‘ìœ„ìˆ˜ ì ˆëŒ€ í¸ì°¨ëŠ” í‘œë³¸ê·¸ë£¹ì˜ ì¤‘ì•™ê°’( $ğ‘‹$ )ê³¼ ê° í‘œë³¸( $ \bar { X } $ )ì˜ ì°¨ì´ê°’ì˜ ì ˆëŒ€ê°’ì„ ì·¨í•´ì„œ ì¤‘ì•™ê°’ì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²•. ì–‘ì  ìë£Œì˜ í¼ì§ì„ ì•Œê³  ì‹¶ì„ ë•Œ, í‘œë³¸ë¶„ì‚°ê³¼ í‘œì¤€í¸ì°¨ ë³´ë‹¤ ì´ìƒì¹˜ì— ëœ ì˜í–¥ì„ ë°›ëŠ” ê°•ê±´ì„± robustness ìˆëŠ” ë¶„ì‚° ì¸¡ì • ë°©ë²•.   

$$MAD = median_{i} |X_{i} - \bar{X}|
\\ \sigma_{MAD} = K \cdot MAD
\\ \text{where } K = 1.4826 \text{ for normal distributed data}$$


**Student t-distribution:**

t-ë¶„í¬ëŠ” ì •ê·œë¶„í¬ $$(\mu, {\sigma}^{2})$$ì—ì„œ $$n$$ ê°œì˜ í‘œë³¸ë“¤ì„ í™•ë¥ ë³€ìˆ˜ë¡œ ì •ì˜ $$(\bar{X} = ğ‘‹_{1},...ğ‘‹_{n})$$í•œ í™•ë¥  ë¶„í¬ì´ë‹¤. ì´ í™•ë¥  ë¶„í¬ ë˜í•œ ì •ê·œë¶„í¬$$(\mu, {\sigma}^{2}/n)$$ì´ë©°, ì´ë¥¼ ìˆ˜ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

$$ \bar{X} \sim  N(\mu, {\sigma}^{2}/n ) $$  

$$\\ T = \frac { \bar{X} - /mu }{ S/\sqrt{n}  } $$


**Grubb's test(=ESD test)**

ë‹¨ì¼ ì´ìƒì¹˜ë¥¼ í…ŒìŠ¤íŠ¸ í•˜ëŠ”ë° ESD test ë°©ë²•ì€ ë„ë¦¬ ì•Œë ¤ì§„ ê¸°ë²•ì´ë‹¤. ESD ê²€ì¦ ë°©ë²•ì˜ ìƒì„¸í•œ ì„¤ëª…ì€ ë³¸ ë³´ê³ ì„œì—ì„œ ìƒëµí•˜ë©°, ì£¼ìš” ìˆ˜ì‹í‘œí˜„ì€ ì•„ë˜ì™€ ê°™ë‹¤. - [ì°¸ê³ :wiki](https://en.wikipedia.org/wiki/Grubbs%27_test_for_outliers )  
ESD ê²€ì •ì€ ì•„ë˜ì™€ ê°™ì€ ê·€ë¬´ê°€ì„¤/ëŒ€ë¦½ê°€ì„¤ì„ í†µí•´ ê²€ì •í•œë‹¤.  

$$ H_{0}: \text{ë°ì´í„° ì…‹ì— ì´ìƒì¹˜ê°€ ì—†ë‹¤} $$
$$ H_{\alpha}: \text{ ë°ì´í„° ì…‹ì— ìµœì†Œí•œ í•˜ë‚˜ì˜ ì´ìƒì¹˜ê°€ ì¡´ì¬í•œë‹¤.}$$  

ì•„ë˜ ì •ì˜ì™€ ê°™ì€ G ê°’ì„ í†µí•´ outlier ì¸ì§€ íŒë³„í•œë‹¤.

 $$ G = max |Y_{i} - \bar{Y}|/s \\ Y: sample mean, s: standard deviation$$

ìµœëŒ€ê°’ê³¼ ìµœì†Œê°’ì„ ë‘˜ ë‹¤ ê²€ì •í•˜ëŠ” two-sided test ì—ì„œ, ì´ìƒì¹˜ê°€ ì—†ë‹¤ëŠ” ê·€ë¬´ê°€ì„¤ì€ significance level( $\alpha$ ) ê°€ ì•„ë˜ë¥¼ ë§Œì¡±í• ì‹œ ê¸°ê°ëœë‹¤.  

$$ G > \frac{N-1}{\sqrt{N}} \sqrt{\frac{t^{2}_{\alpha(2N), N-2}}{N-2+t^{2}_{\alpha(2N), N-2}}}
\\ t^{2}_{\alpha(2N), N-2}: \text{upper critical value of the 't-test' with}
\\ \text{ N-2 degrees of freedom and significance level of} \alpha/{2N} $$  

ESD í…ŒìŠ¤íŠ¸ëŠ” ì •ìƒì„± (normality) ë¥¼ ê°€ì •í•˜ê³ , ë‹¨ì¼ ì´ìƒì¹˜ë¥¼ íƒì§€í•˜ëŠ”ë° ì í•©í•˜ë‹¤ëŠ” í•œê³„ ë•Œë¬¸ì—, ì‹œê³„ì—´ê³¼ ê°™ì€ ì—°ì†ì  ë°ì´í„°ì—ì„œ ì§€ì†ì ìœ¼ë¡œ ì´ìƒíƒì§€ë¥¼ í•´ì•¼í•˜ëŠ” ê²½ìš°, ì•„ë˜ì™€ ê°™ì€ Generalized ESD ì˜ ì‚¬ìš©ì´ ê¶Œì¥ëœë‹¤.


**Generalized Extreme Studentized Deviate (Generalized ESD):**
Generalized ESD ëŠ” Grubb's testì™€ ë‹¬ë¦¬ ì—¬ëŸ¬ê°œì˜ outlierë¥¼ ê°€ì •í•œ ê²€ì •ë°©ë²•ì„. ê°€ì¥ ë†’ì€ G ë°¸ë¥˜ë¥¼ ì œê±°í•´ ë‚˜ê°€ë©´ì„œ ì§€ì†ì ìœ¼ë¡œ ìˆœíšŒí•˜ì—¬ í‰ê· ê³¼ í‘œì¤€í¸ì°¨ë¥¼ ì—…ë°ì´íŠ¸í•´ë‚˜ê°€ëŠ” ë°©ì‹.

$$ R_{i} = max |x_{i} -\bar{x}|/s
\\ \lambda_{i} > \frac{(N-1)\cdot t_{p,n-i-1}}{\sqrt{(N-i-1+t^{2}_{p,n-i-1}) (n-i+1)}}$$

ìœ„ì— ëª…ì‹œëœ Critical Value($\lambda_{i}$) ë˜í•œ ì§€ì†ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë˜ë©°, $R_{i} > \lambda_{i} $ë¥¼ ë§Œì¡±í•˜ëŠ” $i$ ê°€ ì´ìƒê°’ì˜ ê°œìˆ˜ë¥¼ ê²°ì •í•˜ê²Œë¨. ë³¸ ê²€ì •ë°©ë²•ì€ ì•ì„  Grubb's test ë³´ë‹¤ ì—¬ëŸ¬ê°œì˜ outlierë¥¼ ê²€ì¶œ í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆìœ¼ë‚˜, ì—¬ì „íˆ ì •ê·œì„±ì„ ê°€ì •í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ì •ê·œì„± í…ŒìŠ¤íŠ¸ ì„ í–‰ì´ ë˜ì–´ì•¼ í•˜ê³ , ê³„ì ˆì„±(seasonality)ì„ ê³ ë ¤í•˜ì§€ ì•ŠëŠ” ë‹¨ì ì´ ìˆë‹¤.

**Seasonal Trend decomposition using Loess(STL):**  
STLì€ ì‹œê³„ì—´ ë°ì´í„°ì—ì„œ ê³„ì ˆì„±, ì¶”ì„¸, ì”ì°¨ ì„¸ê°€ì§€ íŒ¨í„´ìš”ì†Œë¡œ ë¶„í•´í•˜ëŠ” ê¸°ë²•ìœ¼ë¡œ (ë³¸ë¬¸ ì „ë°˜ë¶€ ì°¸ì¡°), seasonalityì™€ trendë¥¼ ì œê±°í•˜ë©´, ì´ìƒíƒì§€ì— ì í•©í•œ residualë§Œ ë‚¨ê²Œ ëœë‹¤.


**êµ¬í˜„**  
- twitter R code  
- Pyculiarity  
- Example  
