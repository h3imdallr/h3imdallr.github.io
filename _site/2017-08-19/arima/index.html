<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Time Series Forecasting with ARIMA</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" type="text/css">

  <!-- Font -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Gradient Descent" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Time Series Forecasting with ARIMA | Gradient Descent</title>
<meta name="generator" content="Jekyll v3.7.2" />
<meta property="og:title" content="Time Series Forecasting with ARIMA" />
<meta name="author" content="Josh Yongmin Jung" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="시계열 예측기법" />
<meta property="og:description" content="시계열 예측기법" />
<link rel="canonical" href="http://localhost:4000/2017-08-19/arima/" />
<meta property="og:url" content="http://localhost:4000/2017-08-19/arima/" />
<meta property="og:site_name" content="Gradient Descent" />
<meta property="og:image" content="http://localhost:4000/figures-h3imdallr/20161123-header-anomaly.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-08-19T09:00:00+09:00" />
<script type="application/ld+json">
{"description":"시계열 예측기법","author":{"@type":"Person","name":"Josh Yongmin Jung"},"@type":"BlogPosting","url":"http://localhost:4000/2017-08-19/arima/","image":"http://localhost:4000/figures-h3imdallr/20161123-header-anomaly.jpg","headline":"Time Series Forecasting with ARIMA","dateModified":"2017-08-19T09:00:00+09:00","datePublished":"2017-08-19T09:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017-08-19/arima/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->



  <!-- Google Analytics -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>



</head>

<body>
  <div class="content-container">
    <header>
  <div class="header-small">
    <a href="http://localhost:4000">Gradient Descent</a>
  </div>
</header>
<div class="post">
  <div class="post-title">Time Series Forecasting with ARIMA</div>
  <span class="post-date">
    <time>19 Aug 2017</time>
  </span>
  <div class="post-tag">
    <ul>
      
      <li>
        <a href="http://localhost:4000/tags#data_science">
          <span>data_science</span>
        </a>
      </li>
      
      
      <li>
        <a href="http://localhost:4000/tags#time_series">
          <span>time_series</span>
        </a>
      </li>
      
      
    </ul>
  </div>

  <h1 id="time-series-forecasting">Time Series Forecasting</h1>

<p><strong>scope</strong>:</p>
<ul>
  <li>시간에 대한 함수, 시간에 따른 변화에 주안,  인과 관계X</li>
  <li>Data Wrangling for time-series in Python</li>
  <li>self projecting(o), cause and effect(X)</li>
  <li>uni-variate(o), multi-variate(x)</li>
  <li>Time-series Basics; seasonality, trend, residual, statrionary/non-stationary process</li>
  <li>Time-series forecasting using ARIMA (Box Jenkins Approach, ACF, PACF)</li>
</ul>

<p><strong>requirements</strong>:</p>
<ul>
  <li>python 2.7 or 3</li>
  <li>
    <p>statsmodel 0.8.0 <br />
(<strong>anaconda user</strong> -&gt; <code class="highlighter-rouge">conda install -c taugspurger statsmodels=0.8.0</code> 참고: https://anaconda.org/search?q=statsmodels%20 <br />
// <strong>pip user</strong> -&gt; <code class="highlighter-rouge">pip install statsmodels==0.8.rc1</code> )</p>
  </li>
  <li>(Jupyter Kernel) (http://stackoverflow.com/questions/28831854/how-do-i-add-python3-kernel-to-jupyter-ipython)</li>
</ul>

<p><strong>reference</strong>: <br />
[1] <a href="http://www.seanabu.com/2016/03/22/time-series-seasonal-ARIMA-model-in-python/">Seasonal ARIMA with Python</a><br />
[2] <a href="https://www.analyticsvidhya.com/blog/2015/12/complete-tutorial-time-series-modeling/">A Complete Tutorial on Time Series Modeling in R</a><br />
[3] <a href="https://www.analyticsvidhya.com/blog/2016/02/time-series-forecasting-codes-python/">A comprehensive beginner’s guide to create a Time Series Forecast (with Codes in Python)</a><br />
[4] <a href="https://www.datascienceschool.net/view-notebook/e0c935b3f55c4302b0fb0c93986562cd/">데이터 사이언스 스쿨/ 시계열 분석</a><br />
[5] <a href="https://www.google.co.kr/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0ahUKEwjJkr3qqvDQAhVIyLwKHUgSDKoQFgggMAA&amp;url=https%3A%2F%2Fbigdata.kookmin.ac.kr%2F%3Fmodule%3Dfile%26act%3DprocFileDownload%26file_srl%3D351%26sid%3D43ea21693d9f550e5e39869d5ce52adc&amp;usg=AFQjCNFeXfnfSgzHQHDP85VZTBUvi4wy0Q&amp;sig2=uZvEKrxxd_rr4Gv4lOB7Yw">시계열 데이터의 통계적 분석 방법</a></p>

<h2 id="1-시계열-데이터-이해">1. 시계열 데이터 이해</h2>

<p>시계열 데이터 분석을 위해서는 기본적으로 시계열 데이터의 요소 및 정상/비정상 과정에 대한 이해가 필요하다.</p>

<p><img src="figure/TS_pattern.png" alt="" />
<em>(출처: [5])</em></p>

<h3 id="11-시계열-데이터-요소">1.1. 시계열 데이터 요소</h3>

<ul>
  <li><strong>추세(Trend)</strong>: 장기적으로 나타나는 변동 패턴</li>
  <li><strong>계절성(Seasonal)</strong>: 주,월,분기,반기 단위 등 이미 알려진 시간의 주기로 나타나는 패턴</li>
  <li><strong>주기(Cyclic)</strong>: 최소 2 년 단위로 나타나는 고정된 기간이 아닌 장기적인 변동</li>
  <li><strong>랜덤요소 (random/residual/remainder)</strong></li>
</ul>

<p><img src="https://anomaly.io/wp-content/uploads/2015/12/time-series-decomposition-seasonal-trend.png" alt="" /></p>

<p><img src="https://anomaly.io/wp-content/uploads/2015/12/multiplicative-decompose.png" alt="" /></p>

<h3 id="12-정상-및-비정상-과정-모형-staionary--non-stationary">1.2. 정상 및 비정상 과정 모형 Staionary &amp; Non-Stationary</h3>

<p>일반적으로 시계열 분석의 용이성을 위해 아래와 같이 비정상과정 모형(𝑌 )에 따르는 시계열 데이터 “
또한 추정 가능한 결정론적 추세함수 ($𝑓_{t}$ , trend) 와 확률 정상과정($ 𝑋_{t} $)의 합으로 가정하고 분석한다.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*} & y_{t}\sim f_{\left( t\right) }+X_{t}\end{align*} %]]></script>

<p>따라서 시계열 데이터 분석에서 정상과정 모형의 특성 및 분석방법들을 이해하는 것이 우선적으로 요구된다. 다음은 정상 시계열 모형과 비정상 시계열 모형의 특징 비교이다.</p>

<p><a href="https://www.datascienceschool.net/view-notebook/0ddd47967585403ab8b4cb60d0e420f6/">상세설명 참고</a></p>

<p><strong>i.시간 추이에 따른 평균값의 불변여부</strong><br />
정상과정 - 평균은 시간에 따라 변화하는 함수가 아니다.;일정한 평균 else 비정상과정</p>

<script type="math/tex; mode=display">E(y_{t}) = \mu</script>

<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/02/Mean_nonstationary.png" alt="" /></p>

<p><strong>ii.시간추이에 따른 분산의 불변여부</strong><br />
정상과정 - 분산은 시간에 따라 변화하는 함수가 아니다.;일정한 분산  else 비정상과정</p>

<script type="math/tex; mode=display">var(y_{t}) = \sigma^{2}</script>

<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/02/Var_nonstationary.png" alt="" /></p>

<p><strong>C.시점간의 공분산</strong><br />
공분산은 t가 아닌 s에 의존함
<script type="math/tex">cov(y_{t}, y_{t+s}) = cov(y_{t}, y_{t-s}) = \gamma_{s}</script>
<script type="math/tex">cov(X,Y) = E((X-\mu)(Y-\upsilon))</script></p>

<p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/02/Cov_nonstationary.png" alt="" /></p>

<p>본 장에서 소개하는 통계적 시계열 추정 모형들은 시계열 데이터를 정상화시킨 모형 위에서 설계되어 있으므로, 필수적으로 데이터를 정상화 시키는 과정이 필요하다.</p>

<h2 id="2-시계열-데이터-분석-framework">2. 시계열 데이터 분석 Framework</h2>

<p>일반적으로 아래와 같은 방법으로 시계열 데이터 분석을 진행한다.<br />
<img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/02/flowchart.png" alt="" /></p>

<p>또는 <a href="https://www.datascienceschool.net/view-notebook/e4b52228ac5749418d51409fdc4f9cef/">링크: 확률 과정 모형을 추정하는 방법</a>와 같은 절차를 통해 확률모형을 추정할 수 있다.</p>

<h3 id="20-pandas-기초">2.0 Pandas 기초</h3>

<p>본 절은 [6]Python for Finance 의 내용을 기초로 함.</p>

<p><a href="https://s3.amazonaws.com/quandl-static-content/Documents/Quandl+-+Pandas,+SciPy,+NumPy+Cheat+Sheet.pdf">참고: pandas cheat sheet</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># create a vector with random numbers</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">print</span> <span class="p">(</span><span class="s">'&gt;&gt;&gt; a=</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>

<span class="c"># create dataframe</span>
<span class="n">fun_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="s">'&gt;&gt;&gt; fun_df=</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">fun_df</span><span class="p">)</span>

<span class="c"># create DatetimeIndex objects</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">'2016-1-1'</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s">'M'</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="s">'&gt;&gt;&gt; dates=</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">dates</span><span class="p">)</span>

<span class="c"># set index of df with 'dates'</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dates</span>
<span class="k">print</span> <span class="p">(</span><span class="s">'&gt;&gt;&gt; fun_df.index=</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">fun_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; a=
 [[-1.293818  0.272272  0.018758 -0.330164]
 [-0.148685 -0.271431  1.00961   1.913422]
 [ 1.948358  1.06523   2.056629 -0.800756]
 [-0.292714 -0.86246  -0.679134  2.018199]
 [ 1.029699  0.038898  2.516392 -0.033658]
 [ 1.403878 -0.577693 -0.992217 -0.834543]
 [-0.006407  0.632325  1.326125  1.069603]
 [ 1.205666  0.051079  0.494714 -0.014192]
 [-2.080606  0.98777   1.64998  -1.058814]]
&gt;&gt;&gt; fun_df=
           0         1         2         3
0 -1.293818  0.272272  0.018758 -0.330164
1 -0.148685 -0.271431  1.009610  1.913422
2  1.948358  1.065230  2.056629 -0.800756
3 -0.292714 -0.862460 -0.679134  2.018199
4  1.029699  0.038898  2.516392 -0.033658
5  1.403878 -0.577693 -0.992217 -0.834543
6 -0.006407  0.632325  1.326125  1.069603
7  1.205666  0.051079  0.494714 -0.014192
8 -2.080606  0.987770  1.649980 -1.058814
&gt;&gt;&gt; dates=
 DatetimeIndex(['2016-01-31', '2016-02-29', '2016-03-31', '2016-04-30',
               '2016-05-31', '2016-06-30', '2016-07-31', '2016-08-31',
               '2016-09-30'],
              dtype='datetime64[ns]', freq='M')
&gt;&gt;&gt; fun_df.index=
                    0         1         2         3
2016-01-31 -1.293818  0.272272  0.018758 -0.330164
2016-02-29 -0.148685 -0.271431  1.009610  1.913422
2016-03-31  1.948358  1.065230  2.056629 -0.800756
2016-04-30 -0.292714 -0.862460 -0.679134  2.018199
2016-05-31  1.029699  0.038898  2.516392 -0.033658
2016-06-30  1.403878 -0.577693 -0.992217 -0.834543
2016-07-31 -0.006407  0.632325  1.326125  1.069603
2016-08-31  1.205666  0.051079  0.494714 -0.014192
2016-09-30 -2.080606  0.987770  1.649980 -1.058814
</code></pre></div></div>

<p><strong>Basic methods:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># index values</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">index</span>

<span class="c"># columns</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">columns</span>

<span class="c"># select via index</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="s">'2016-02-29'</span><span class="p">]</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">fun_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
<span class="n">fun_df</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-02-29</th>
      <td>-0.148685</td>
      <td>-0.271431</td>
      <td>1.009610</td>
      <td>1.913422</td>
    </tr>
    <tr>
      <th>2016-03-31</th>
      <td>1.948358</td>
      <td>1.065230</td>
      <td>2.056629</td>
      <td>-0.800756</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>LAMBDA func, apply()</strong> - <a href="https://wikidocs.net/64">lambda - 참고</a>, <a href="http://chrisalbon.com/python/pandas_apply_operations_to_dataframes.html">apply - 참고</a></p>

<p><img src="http://nbviewer.jupyter.org/github/h3imdallr/TIL-datascience/blob/master/ipynb_gitHub/images/non-builtin.png" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># apply()</span>
<span class="n">fun_df</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-01-31</th>
      <td>1.673966</td>
      <td>0.074132</td>
      <td>0.000352</td>
      <td>0.109008</td>
    </tr>
    <tr>
      <th>2016-02-29</th>
      <td>0.022107</td>
      <td>0.073675</td>
      <td>1.019312</td>
      <td>3.661183</td>
    </tr>
    <tr>
      <th>2016-03-31</th>
      <td>3.796097</td>
      <td>1.134715</td>
      <td>4.229723</td>
      <td>0.641210</td>
    </tr>
    <tr>
      <th>2016-04-30</th>
      <td>0.085681</td>
      <td>0.743837</td>
      <td>0.461223</td>
      <td>4.073126</td>
    </tr>
    <tr>
      <th>2016-05-31</th>
      <td>1.060280</td>
      <td>0.001513</td>
      <td>6.332228</td>
      <td>0.001133</td>
    </tr>
    <tr>
      <th>2016-06-30</th>
      <td>1.970874</td>
      <td>0.333730</td>
      <td>0.984494</td>
      <td>0.696463</td>
    </tr>
    <tr>
      <th>2016-07-31</th>
      <td>0.000041</td>
      <td>0.399834</td>
      <td>1.758607</td>
      <td>1.144051</td>
    </tr>
    <tr>
      <th>2016-08-31</th>
      <td>1.453630</td>
      <td>0.002609</td>
      <td>0.244742</td>
      <td>0.000201</td>
    </tr>
    <tr>
      <th>2016-09-30</th>
      <td>4.328922</td>
      <td>0.975689</td>
      <td>2.722433</td>
      <td>1.121087</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># insert another column (dimension expansion)</span>
<span class="n">fun_df</span><span class="p">[</span><span class="s">'new'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">fun_df</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>new</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-01-31</th>
      <td>-1.293818</td>
      <td>0.272272</td>
      <td>0.018758</td>
      <td>-0.330164</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-02-29</th>
      <td>-0.148685</td>
      <td>-0.271431</td>
      <td>1.009610</td>
      <td>1.913422</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-03-31</th>
      <td>1.948358</td>
      <td>1.065230</td>
      <td>2.056629</td>
      <td>-0.800756</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-04-30</th>
      <td>-0.292714</td>
      <td>-0.862460</td>
      <td>-0.679134</td>
      <td>2.018199</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-05-31</th>
      <td>1.029699</td>
      <td>0.038898</td>
      <td>2.516392</td>
      <td>-0.033658</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-06-30</th>
      <td>1.403878</td>
      <td>-0.577693</td>
      <td>-0.992217</td>
      <td>-0.834543</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-07-31</th>
      <td>-0.006407</td>
      <td>0.632325</td>
      <td>1.326125</td>
      <td>1.069603</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-08-31</th>
      <td>1.205666</td>
      <td>0.051079</td>
      <td>0.494714</td>
      <td>-0.014192</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2016-09-30</th>
      <td>-2.080606</td>
      <td>0.987770</td>
      <td>1.649980</td>
      <td>-1.058814</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fun_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'A'</span><span class="p">,</span><span class="s">'B'</span><span class="p">,</span><span class="s">'C'</span><span class="p">,</span><span class="s">'D'</span><span class="p">,</span><span class="s">'E'</span><span class="p">]</span>

<span class="c"># sum</span>
<span class="n">fun_df</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="c"># mean</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c"># std</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c"># numpy universal functions</span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fun_df</span><span class="p">)</span>

<span class="c"># general stats</span>
<span class="n">fun_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:14: RuntimeWarning: invalid value encountered in sqrt
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>9.000000</td>
      <td>9.000000</td>
      <td>9.000000</td>
      <td>9.000000</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.196152</td>
      <td>0.148443</td>
      <td>0.822317</td>
      <td>0.214344</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.325015</td>
      <td>0.665340</td>
      <td>1.207646</td>
      <td>1.174413</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.080606</td>
      <td>-0.862460</td>
      <td>-0.992217</td>
      <td>-1.058814</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.292714</td>
      <td>-0.271431</td>
      <td>0.018758</td>
      <td>-0.800756</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.006407</td>
      <td>0.051079</td>
      <td>1.009610</td>
      <td>-0.033658</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.205666</td>
      <td>0.632325</td>
      <td>1.649980</td>
      <td>1.069603</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.948358</td>
      <td>1.065230</td>
      <td>2.516392</td>
      <td>2.018199</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fun_df</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="c"># plt.plot(fun_df)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x10e133828&gt;
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_14_1.png" alt="png" /></p>

<p><strong>Groupby Operations</strong></p>

<p>SQL의 group select , 엑셀의 pivot table과 비슷한 기능</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fun_df</span><span class="p">[</span><span class="s">'Quarter'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Q1'</span><span class="p">,</span><span class="s">'Q1'</span><span class="p">,</span><span class="s">'Q1'</span><span class="p">,</span><span class="s">'Q2'</span><span class="p">,</span><span class="s">'Q2'</span><span class="p">,</span><span class="s">'Q2'</span><span class="p">,</span><span class="s">'Q3'</span><span class="p">,</span><span class="s">'Q3'</span><span class="p">,</span><span class="s">'Q3'</span><span class="p">]</span>
<span class="n">fun_df</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>Quarter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-01-31</th>
      <td>-1.293818</td>
      <td>0.272272</td>
      <td>0.018758</td>
      <td>-0.330164</td>
      <td>0.0</td>
      <td>Q1</td>
    </tr>
    <tr>
      <th>2016-02-29</th>
      <td>-0.148685</td>
      <td>-0.271431</td>
      <td>1.009610</td>
      <td>1.913422</td>
      <td>0.0</td>
      <td>Q1</td>
    </tr>
    <tr>
      <th>2016-03-31</th>
      <td>1.948358</td>
      <td>1.065230</td>
      <td>2.056629</td>
      <td>-0.800756</td>
      <td>0.0</td>
      <td>Q1</td>
    </tr>
    <tr>
      <th>2016-04-30</th>
      <td>-0.292714</td>
      <td>-0.862460</td>
      <td>-0.679134</td>
      <td>2.018199</td>
      <td>0.0</td>
      <td>Q2</td>
    </tr>
    <tr>
      <th>2016-05-31</th>
      <td>1.029699</td>
      <td>0.038898</td>
      <td>2.516392</td>
      <td>-0.033658</td>
      <td>0.0</td>
      <td>Q2</td>
    </tr>
    <tr>
      <th>2016-06-30</th>
      <td>1.403878</td>
      <td>-0.577693</td>
      <td>-0.992217</td>
      <td>-0.834543</td>
      <td>0.0</td>
      <td>Q2</td>
    </tr>
    <tr>
      <th>2016-07-31</th>
      <td>-0.006407</td>
      <td>0.632325</td>
      <td>1.326125</td>
      <td>1.069603</td>
      <td>0.0</td>
      <td>Q3</td>
    </tr>
    <tr>
      <th>2016-08-31</th>
      <td>1.205666</td>
      <td>0.051079</td>
      <td>0.494714</td>
      <td>-0.014192</td>
      <td>0.0</td>
      <td>Q3</td>
    </tr>
    <tr>
      <th>2016-09-30</th>
      <td>-2.080606</td>
      <td>0.987770</td>
      <td>1.649980</td>
      <td>-1.058814</td>
      <td>0.0</td>
      <td>Q3</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">groups</span> <span class="o">=</span> <span class="n">fun_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Quarter'</span><span class="p">)</span>
<span class="n">groups</span> <span class="c">#groupby 객체임</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;pandas.core.groupby.DataFrameGroupBy object at 0x110de7470&gt;
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">groups</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">groups</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
<span class="n">groups</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Quarter
Q1    3
Q2    3
Q3    3
dtype: int64
</code></pre></div></div>

<p>두개의 열을 동시에 기준으로 하는 그룹 지정도 가능</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fun_df</span><span class="p">[</span><span class="s">'Odd_Even'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Odd'</span><span class="p">,</span><span class="s">'Even'</span><span class="p">,</span><span class="s">'Odd'</span><span class="p">,</span><span class="s">'Even'</span><span class="p">,</span><span class="s">'Odd'</span><span class="p">,</span><span class="s">'Even'</span><span class="p">,</span><span class="s">'Odd'</span><span class="p">,</span><span class="s">'Even'</span><span class="p">,</span><span class="s">'Odd'</span><span class="p">]</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">fun_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'Quarter'</span><span class="p">,</span><span class="s">'Odd_Even'</span><span class="p">])</span>
<span class="n">groups</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="n">groups</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
    </tr>
    <tr>
      <th>Quarter</th>
      <th>Odd_Even</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Q1</th>
      <th>Even</th>
      <td>-0.148685</td>
      <td>-0.271431</td>
      <td>1.009610</td>
      <td>1.913422</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Odd</th>
      <td>0.327270</td>
      <td>0.668751</td>
      <td>1.037693</td>
      <td>-0.565460</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Q2</th>
      <th>Even</th>
      <td>0.555582</td>
      <td>-0.720077</td>
      <td>-0.835676</td>
      <td>0.591828</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Odd</th>
      <td>1.029699</td>
      <td>0.038898</td>
      <td>2.516392</td>
      <td>-0.033658</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Q3</th>
      <th>Even</th>
      <td>1.205666</td>
      <td>0.051079</td>
      <td>0.494714</td>
      <td>-0.014192</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Odd</th>
      <td>-1.043507</td>
      <td>0.810047</td>
      <td>1.488052</td>
      <td>0.005395</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="21-eda-시계열-데이터-확인하기">2.1 EDA; 시계열 데이터 확인하기</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>

<span class="kn">import</span> <span class="nn">statsmodels</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>  
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">acf</span>  
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">pacf</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="kn">import</span> <span class="n">seasonal_decompose</span>
</code></pre></div></div>

<ul>
  <li><strong>Wrangling</strong>:
dropna, column name, DF slicing, date_range, type conversion</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/portland-oregon-average-monthly.csv'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">'Month'</span><span class="p">)</span>

<span class="c">#preprocessing</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'ridership'</span><span class="p">]</span>
<span class="k">print</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span><span class="s">'</span><span class="se">\n</span><span class="s"> ... </span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span> <span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        ridership
Month            
1960-01       648
1960-02       646
1960-03       639
1960-04       654
1960-05       630
 ...
                                                    ridership
Month                                                       
1969-03                                                 1419
1969-04                                                 1432
1969-05                                                 1394
1969-06                                                 1327
Portland Oregon average monthly bus ridership (...     n=114
        ridership
Month            
1969-02      1425
1969-03      1419
1969-04      1432
1969-05      1394
1969-06      1327
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#ERROR --&gt; index type should be 'datetime'</span>
<span class="c"># df.plot()</span>
</code></pre></div></div>

<ul>
  <li>change df.index as datetime object:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OPTION(1): to_datetime()</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">);</span> <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span><span class="s">'</span><span class="se">\n</span><span class="s"> ... </span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>           ridership
Month               
1960-01-01       648
1960-02-01       646
1960-03-01       639
1960-04-01       654
1960-05-01       630
 ...
            ridership
Month               
1969-02-01      1425
1969-03-01      1419
1969-04-01      1432
1969-05-01      1394
1969-06-01      1327
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OPTION(2): date_range()</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">"1960-01"</span><span class="p">,</span><span class="s">"1969-06"</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s">"MS"</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">);</span> <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span><span class="s">'</span><span class="se">\n</span><span class="s"> ... </span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>           ridership
1960-01-01       648
1960-02-01       646
1960-03-01       639
1960-04-01       654
1960-05-01       630
 ...
            ridership
1969-02-01      1425
1969-03-01      1419
1969-04-01      1432
1969-05-01      1394
1969-06-01      1327
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># DF time slicing with datetime</span>
<span class="n">time_window_l</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1960</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">time_window_r</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1961</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">time_window_l</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">time_window_r</span><span class="p">)]</span>
<span class="c"># print (temp_df)</span>

<span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[:</span><span class="n">time_window_l</span><span class="p">]</span>
<span class="c"># print (temp_df)</span>
</code></pre></div></div>

<ul>
  <li>change type of dataframe’s column</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
<span class="c"># OR, alternatively,</span>
<span class="c"># df['ridership'] = df['ridership'].apply(lambda x: int(x))</span>
<span class="c"># df.dtypes</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ridership    int64
dtype: object
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="c"># df.plot(figsize=(12,8), title = 'Montly Ridership', fontsize=14)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x11183b588&gt;
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_32_1.png" alt="png" /></p>

<h4 id="seasonal-decomposition-stl">Seasonal Decomposition (STL)</h4>

<p>남은 residual value를 추출함으로써, time-independent한 time-series를 뽑음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">decomposition</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>  
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  
<span class="n">fig</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.figure.Figure at 0x1118fe198&gt;
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_34_1.png" alt="png" /></p>

<p>Seasonal Trend Decomposition (STL) 활용:</p>
<ul>
  <li>Anomaly Deteciton (residual활용)</li>
  <li>Stationarize</li>
  <li>시계열 패턴 비교 (예시, 아래)</li>
</ul>

<p><img src="figure/STL_example.png" alt="" /></p>

<h3 id="22-시계열-데이터-정상화-하기">2.2 시계열 데이터 정상화 하기</h3>

<h3 id="정상성-확인-stationarity-check">정상성 확인 stationarity check</h3>
<p>일반적으로 데이터가 stationary한 경우는 거의 없음.
정상성을 Test하기 위해서 두가지 방법 사용</p>

<p><strong>(1) 눈으로 직관적 확인 ~ STL, Rolling statistics(moving average)  <br />
(2) Dickey-FUller test <a href="https://www.datascienceschool.net/view-notebook/ebb638fc880145b9adeef8dfa630f067/">링크</a></strong></p>

<p>아래는  Dickey-Fuller test 와 더불어  trend를 추출하는 방법중 하나인 rolling statistics를 이용해서 동시에 정상성을 검사하는 방법이다</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">adfuller</span>
<span class="k">def</span> <span class="nf">test_stationarity</span><span class="p">(</span><span class="n">timeseries</span><span class="p">):</span>

    <span class="c">#Determing rolling statistics</span>
    <span class="n">rolmean</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">rolstd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">rolling_std</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c">#Plot rolling statistics:</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'blue'</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">'Original'</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolmean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Rolling Mean'</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolstd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Rolling Std'</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'best'</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Rolling Mean &amp; Standard Deviation'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c">#Perform Dickey-Fuller test:</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">'&lt;Results of Dickey-Fuller Test&gt;'</span><span class="p">)</span>
    <span class="n">dftest</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">autolag</span><span class="o">=</span><span class="s">'AIC'</span><span class="p">)</span>
    <span class="n">dfoutput</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dftest</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>
                         <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">'Test Statistic'</span><span class="p">,</span><span class="s">'p-value'</span><span class="p">,</span><span class="s">'#Lags Used'</span><span class="p">,</span><span class="s">'Number of Observations Used'</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">dftest</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">dfoutput</span><span class="p">[</span><span class="s">'Critical Value (</span><span class="si">%</span><span class="s">s)'</span><span class="o">%</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">dfoutput</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_stationarity</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:5: FutureWarning: pd.rolling_mean is deprecated for Series and will be removed in a future version, replace with
	Series.rolling(center=False,window=12).mean()
/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:6: FutureWarning: pd.rolling_std is deprecated for Series and will be removed in a future version, replace with
	Series.rolling(center=False,window=12).std()
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_38_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Results of Dickey-Fuller Test&gt;
Test Statistic                  -1.536597
p-value                          0.515336
#Lags Used                      12.000000
Number of Observations Used    101.000000
Critical Value (1%)             -3.496818
Critical Value (5%)             -2.890611
Critical Value (10%)            -2.582277
dtype: float64
</code></pre></div></div>

<ul>
  <li>Judgment: <br />
(null-hypothesis: TS is non-stationary)<br />
p-value &lt; 0.05: reject null-hypothesis –&gt; Stationary<br />
p-value &gt; 0.05: accept –&gt; non-Stationary</li>
</ul>

<h3 id="정상화-stationarize">정상화 Stationarize</h3>

<p>비정상 확률과정을 정상 확률 과정으로 변환하는 방법은 여러가지 <a href="http://people.duke.edu/~rnau/whatuse.htm">[1]</a>, <a href="https://www.datascienceschool.net/view-notebook/3f485c426a4b49fc9de95a02137ca6b4/">[2]</a>가 있으며, 주어진 데이터에 따라 가장 효율적인 방법이 다르거나 혼합하여 사용한다. (상세내용 링크참조)
여기서는 짧게 세가지에 대해서 소개한다.</p>
<ul>
  <li><strong>차분(differencing)</strong>: 1차차분. Trend 제거하는데 용이 $\Delta y_{t} = y_{t} - y_{t-1}$</li>
  <li><strong>로그변환(lograithm)</strong>: 표준편차가 자료의 크기에 비례하여 증가할때</li>
  <li><strong>Box-Cox 변환</strong>: 정규분포가 아닌 자료를 정규분포로 변환.</li>
</ul>

<p>여기서는 차분을 이용하여 정상화를 한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'first_difference'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  
<span class="c"># Or Alternatively,</span>
<span class="c"># df.diff().plot()</span>
<span class="n">test_stationarity</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">first_difference</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:5: FutureWarning: pd.rolling_mean is deprecated for Series and will be removed in a future version, replace with
	Series.rolling(center=False,window=12).mean()
/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:6: FutureWarning: pd.rolling_std is deprecated for Series and will be removed in a future version, replace with
	Series.rolling(center=False,window=12).std()
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_41_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Results of Dickey-Fuller Test&gt;
Test Statistic                  -1.938696
p-value                          0.314082
#Lags Used                      11.000000
Number of Observations Used    101.000000
Critical Value (1%)             -3.496818
Critical Value (5%)             -2.890611
Critical Value (10%)            -2.582277
dtype: float64
</code></pre></div></div>

<p>좀더 나은 수준의 정상화를 위해, 도한 seasonal 패턴을 좀더 명확히 보고 싶고, long-term에서도 잘 남아있게 하기 위해서 seasonaly differencing 을 적용한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'seasonal_first_difference'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'first_difference'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s">'first_difference'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>  
<span class="n">test_stationarity</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">seasonal_first_difference</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c"># Else:</span>
<span class="c"># df['log_first_difference'] = df.riders_log - df.riders_log.shift(1)</span>
<span class="c"># df['seasonal_difference'] = df.riders - df.riders.shift(12)  </span>
<span class="c"># df['log_seasonal_difference'] = df.riders_log - df.riders_log.shift(12)</span>
<span class="c"># df['log_seasonal_first_difference'] = df.log_first_difference - df.log_first_difference.shift(12)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:5: FutureWarning: pd.rolling_mean is deprecated for Series and will be removed in a future version, replace with
	Series.rolling(center=False,window=12).mean()
/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/ipykernel/__main__.py:6: FutureWarning: pd.rolling_std is deprecated for Series and will be removed in a future version, replace with
	Series.rolling(center=False,window=12).std()
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_43_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Results of Dickey-Fuller Test&gt;
Test Statistic                -9.258520e+00
p-value                        1.427874e-15
#Lags Used                     0.000000e+00
Number of Observations Used    1.000000e+02
Critical Value (1%)           -3.497501e+00
Critical Value (5%)           -2.890906e+00
Critical Value (10%)          -2.582435e+00
dtype: float64
</code></pre></div></div>

<p>p-value가 더 높아진 점에서 seasonal first difference를 통해 최종적으로 data를 정상화 시켰다고 판단한다.추가적으로 로그변환(<code class="highlighter-rouge">df[~] = np.log(df[~])</code>)도 할 수 있으나, 본 경우에서는 분석후 크게 나아지지 않았다.
또한 추가로 추세를 추정하여 제거하는 기법<a href="https://www.datascienceschool.net/view-notebook/240b62a8927043c79b5384536e42f99d/">(링크: 결정론적 추세/다항식 추세/ 계절성 추세 추정)</a>들이 있으나, 충분히 정상화 되었다고 판단하고 본 분석에서는 소개하지 않는다.</p>

<p>### 2.3 모수추정;  최적 파라미터(모형차수) 도출</p>

<h3 id="arima-모델의-개념">ARIMA 모델의 개념</h3>

<ul>
  <li>출처: <a href="https://www.datascienceschool.net/view-notebook/d5226389a8414583a45fb47e1e1cf6fb/">데이터 사이언스 스쿨</a></li>
</ul>

<p><strong>a. 정상과정 확률 모형(1/2) - General Linear Process Model</strong><br />
정상확률 과정에서 가장 일반적으로 사용되는 모형은 일반선형 확률 과정 모형(General Linear Process Model)이다. 해당 모형은 시계열이 <a href="https://www.datascienceschool.net/view-notebook/6b963e771dc54f8c8cb23437274a86d6/">가우시안 백색잡음</a> ($e_{t}$)의 현재값과 과거값들의 선형조합으로 이루어져 있다고 가정. $\psi $ 는 가중계수(weight coefficient).</p>

<script type="math/tex; mode=display">Y_t = e_t + \psi_1 e_{t-1}  + \psi_2 e_{t-2}  + \psi_1 e_{t-3}  + \cdots</script>

<p>위 모형의 블럭 다이어그램은 다음과 같다.</p>

<p><img src="figure/glpm.png" alt="" /></p>

<p><strong>b. 정상과정 확률 모형 (2/2) MA, AR, ARMA</strong></p>

<p>일반 선형 확률 과정 모형은 계수의 특성에 따라 다음과 같은 하위 모형으로 분류된다.</p>

<ul>
  <li><strong>MA (Moving Average) 모형</strong>: 백색 잡음의 현재 값과 과거 값 중 유한(finite)개의 값에 대한 선형 가중합(linear weighted summation)으로 나타나는 확률 과정.q차수에 대해서 MA(q)로 표기</li>
</ul>

<p><script type="math/tex">Y_t = e_t - \theta_1 e_{t-1}  - \theta_2 e_{t-2} - \cdots - \theta_q e_{t-q}</script>
<img src="figure/ma.png" alt="" /></p>

<ul>
  <li><strong>AR (Auto-Regressive) 모형</strong>: 자기 자신의 과거값에 의존적인 모형. 백색 잡음의 현재값과 자기 자신의 과거값의 선형 가중합으로 이루어진 정상 확률 모형. p차수의 AR모형: AR(p)</li>
</ul>

<script type="math/tex; mode=display">Y_t = \phi_1 Y_{t-1}  + \phi_2 Y_{t-2}  + \cdots + \phi_p Y_{t-p}  + e_t</script>

<p><img src="figure/ar.png" alt="" /></p>

<p>이 모형이 선형확률과정을 따르는 것은 아래와 같이 증명 할 수 있다.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{eqnarray}
Y_t
&=& \phi Y_{t-1} + e_t \\
&=& \phi \left( \phi Y_{t-2} + e_{t-1} \right) + e_t \\
&=& \phi^2 Y_{t-2} + \phi e_{t-1} + e_t \\
&=& \phi^2  \left( \phi Y_{t-3} + e_{t-2} \right)  + \phi e_{t-1} + e_t \\
&=& \phi^3 Y_{t-3} + \phi^2 e_{t-2}  + \phi e_{t-1} + e_t \\
&\vdots& \\
&=& e_t + \phi e_{t-1} + \phi^2 e_{t-2} + \phi^3 e_{t-3} + \cdots  \\
\end{eqnarray} %]]></script>

<ul>
  <li><strong>ARMA (Auto-Regressive Moving Average) 모형</strong>: ARMA(p,q) 모형은 AR(p) 모형과 MA(q) 모형의 특징을 모두 가지는 모형을 말함.</li>
</ul>

<script type="math/tex; mode=display">Y_t = \phi_1 Y_{t-1} + \phi_2 Y_{t-2} + \cdots + \phi_p Y_{t-p} + e_t - \theta_1 e_{t-1} - \theta_2 e_{t-2} \cdots  - \theta_q e_{t-q}</script>

<p>**c. 비정상과정확률모형 -  ARIMA **</p>

<p>비정상 과정 모형 중 가장 대표적인 모형으로,  ARMA 모형을 누적한 모형이다. 시계열  $Y_{t}$ 을 차분한 결과로 만들어진 시계열 $\nabla Y_t = Y_t - Y_{t-1}$  이 ARMA 모형을 따르면 원래의 시계열 $Y_{t}$ 를 ARIMA(Autoregressive Integrated Moving Average) 모형이라고 한다.</p>

<p>만약  $d$ 번 차분한 후에야 시계열  $\nabla Y_t$ 가 ARMA(p,q) 모형을 따른다면 적분 차수(order of integration)가  $d$ 인 ARIMA 모형으로 ARIMA(p, d, q)로 표기한다.  $q=0$ 인 경우에는 ARI(p,d), $p=0$ 인 경우에는 IMA(d,q)로 표기한다.</p>

<h3 id="arima-모형-차수-결정">ARIMA 모형 차수 결정</h3>

<p>앞서 설명한 ARIMA의 p, d, q 모형차수는 아래와 같은 방법으로 결정 할 수 있다. <a href="https://www.datascienceschool.net/view-notebook/b39ccd2da3e64d6e91981e23e01816c4/">(상세참조)</a></p>

<ul>
  <li><strong>Augmented Dickey-Fuller 검정</strong> : d</li>
  <li><strong>자기상관계수 함수(ACF)</strong>: q</li>
  <li><strong>편자기상관계수 함수(PACF)</strong> : p</li>
</ul>

<p>| 모형        | ACF  | PACF  |
| :——-: |:————-:| :————-:|
| AR(p)| 지수함수적으로 감소하거나 점차 진폭이 축소되는 사인 곡선의 파동을 나타내거나 또는 양쪽모두 나타남 (시차가 증가함에 따라0 으로 급속히 접근) |p 의 시차까지 유의성 있는 값을 나타내고 이후 소멸함|
| MA(q)| q 의 시차까지 유의성 있는 값을 나타내고 이후 소멸함 | 지수함수적으로 감소하거나 점차진폭이 축소되는 사인 곡선의 파동을 나타내거나 또는 양쪽 모두 나타남 (시차가 증가함에 따라 0 으로급속히접근)|
| ARMA(p,q)| 지수함수적으로 감소하거나 점차 진폭이 축소되는 사인 곡선의 파동을 나타내거나 또는 양쪽 모두 나타남 (시차가 증가함에 따라 0 으로 급속히 접근) | 지수함수적으로 감소하거나 점차 진폭이 축소되는 사인 곡선의 파동을 나타내거나 또는 양쪽 모두 나타남 (시차가 증가함에 따라 0 으로 급속히 접근) |
<img src="figure/parameter.png" alt="" />
<img src="figure/ARIMA.png" alt="ARIMA" /></p>

<p>본 분석에서는 연단위(12개월) 차이로 정상화 시켜서, Seasonal ARIMA 모델로 분류됨.</p>
<blockquote>
  <p>Seasonal ARIMA 모형은 줄여서 SARIMA라고 하기도 한다. 단순 SARIMA 모형은 각 계절에 따른 독립적인 ARIMA 모형이 합쳐져 있는 모형이다. 기존 ARIMA(p,d,q) 모형에 계절성 주기를 나타내는 차수 s가 추가적으로 필요하기 때문에 SARIMA(P,D,Q,s) 로 표기한다.<br />
s의 값은 월별 계절성을 나타낼 때는  $s=12$ 가 되고 분기별 계절성을 나타낼 때는  $s=4$ 가 된다</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">plot_acf</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">seasonal_first_difference</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">13</span><span class="p">:],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">plot_pacf</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">seasonal_first_difference</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">13</span><span class="p">:],</span><span class="n">lags</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_48_0.png" alt="png" /></p>

<p>위 그래프에서, 1차 차분한 값(first_diff)이 t+1..t+12까지 AR(0), MR(0), d=1.</p>

<p>12번째에서 +-&gt;- SAR(1), SMA(1)</p>

<p>최종적으로 <strong>SARIMA (0,1,0)X(1,1,1,12)</strong></p>

<p>SARIMA 모형추정 <a href="https://www.datascienceschool.net/view-notebook/602e62fc1c544ffcb43c2c7e1484dc14/">예시</a></p>

<h3 id="24-모델-수립">2.4 모델 수립</h3>
<p>위 단계에서 확정한 모델의 모형차수를 이용하여, (Seasonal) ARIMA 모델을 생성한다</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">SARIMAX</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'ridership'</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="k">print</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="c"># import statsmodels.api as sm  </span>
<span class="c"># mod = sm.tsa.statespace.SARIMAX(df['ridership'], trend='n', order=(0,1,0), seasonal_order=(0,1,1,12))</span>
<span class="c"># results = mod.fit()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                 Statespace Model Results                                 
==========================================================================================
Dep. Variable:                          ridership   No. Observations:                  114
Model:             SARIMAX(0, 1, 0)x(1, 1, 1, 12)   Log Likelihood                -501.340
Date:                            Thu, 22 Dec 2016   AIC                           1008.680
Time:                                    10:37:58   BIC                           1016.889
Sample:                                01-01-1960   HQIC                          1012.012
                                     - 06-01-1969                                         
Covariance Type:                              opg                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
ar.S.L12       0.3236      0.115      2.816      0.005       0.098       0.549
ma.S.L12      -0.9990      2.489     -0.401      0.688      -5.878       3.880
sigma2       984.6913   2426.491      0.406      0.685   -3771.144    5740.527
===================================================================================
Ljung-Box (Q):                       36.56   Jarque-Bera (JB):                 4.81
Prob(Q):                              0.63   Prob(JB):                         0.09
Heteroskedasticity (H):               1.48   Skew:                             0.38
Prob(H) (two-sided):                  0.26   Kurtosis:                         3.75
===================================================================================

Warnings:
[1] Covariance matrix calculated using the outer product of gradients.
</code></pre></div></div>

<h2 id="평가">평가</h2>
<p>모형이 훌륭하다면 이 값은 더이상 예측할 수 있는 요소가 전혀 없는 시계열 즉, 가우시안 백색 잡음에 가까운 특성을 보여야 한다.<br />
백색잡음: 백색 잡음  $e$ 은 확률 과정을 구성하는 모든 개별 확률 변수  $e_{t}$ 들이 서로 독립이고(independent) 동일한 확률 분포를 따르는(identically distributed) 확률 과정을 말한다.</p>

<p>백색 잡음은 다음과 같은 특성을 만족한다.</p>

<ul>
  <li>
    <p>정상 과정(stictly stationary process)이다.</p>
  </li>
  <li>
    <p>시차(lag)가 0일 경우, 자기공분산은 확률 분포의 분산이 되고 시차가 0이 아닌 경우, 자기공분산은 0이다.</p>
  </li>
</ul>

<script type="math/tex; mode=display">% <![CDATA[
\gamma_l = \begin{cases} \text{Var}[e_t] & \;\; \text{ for } l = 0 \\  0 & \;\; \text{ for }  l \neq 0 \end{cases} %]]></script>

<ul>
  <li>시차(lag)가 0일 경우, 자기상관계수는 1이 되고 시차가 0이 아닌 경우, 자기상관계수는 0이다.</li>
</ul>

<script type="math/tex; mode=display">% <![CDATA[
\rho_l = \begin{cases} 1 & \;\; \text{ for } l = 0 \\  0 & \;\; \text{ for }  l \neq 0 \end{cases} %]]></script>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span><span class="o">.</span><span class="n">plot_diagnostics</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">w_pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">h_pad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_53_0.png" alt="png" /></p>

<h3 id="25--시계열-예측">2.5  시계열 예측</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'forecast'</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dynamic</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>  
<span class="n">df</span><span class="p">[[</span><span class="s">'ridership'</span><span class="p">,</span> <span class="s">'forecast'</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/statsmodels/base/data.py:551: FutureWarning: TimeSeries is deprecated. Please use Series
  return TimeSeries(squeezed, index=self.predict_dates)
</code></pre></div></div>

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ridership</th>
      <th>first_difference</th>
      <th>seasonal_first_difference</th>
      <th>forecast</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1968-07-01</th>
      <td>1258</td>
      <td>-79.0</td>
      <td>-7.0</td>
      <td>1296.346206</td>
    </tr>
    <tr>
      <th>1968-08-01</th>
      <td>1214</td>
      <td>-44.0</td>
      <td>11.0</td>
      <td>1258.596774</td>
    </tr>
    <tr>
      <th>1968-09-01</th>
      <td>1326</td>
      <td>112.0</td>
      <td>-19.0</td>
      <td>1356.836145</td>
    </tr>
    <tr>
      <th>1968-10-01</th>
      <td>1417</td>
      <td>91.0</td>
      <td>82.0</td>
      <td>1395.808702</td>
    </tr>
    <tr>
      <th>1968-11-01</th>
      <td>1417</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>1394.657184</td>
    </tr>
    <tr>
      <th>1968-12-01</th>
      <td>1329</td>
      <td>-88.0</td>
      <td>-24.0</td>
      <td>1339.628128</td>
    </tr>
    <tr>
      <th>1969-01-01</th>
      <td>1461</td>
      <td>132.0</td>
      <td>63.0</td>
      <td>1424.051451</td>
    </tr>
    <tr>
      <th>1969-02-01</th>
      <td>1425</td>
      <td>-36.0</td>
      <td>-47.0</td>
      <td>1438.092678</td>
    </tr>
    <tr>
      <th>1969-03-01</th>
      <td>1419</td>
      <td>-6.0</td>
      <td>20.0</td>
      <td>1407.277891</td>
    </tr>
    <tr>
      <th>1969-04-01</th>
      <td>1432</td>
      <td>13.0</td>
      <td>3.0</td>
      <td>1427.492444</td>
    </tr>
    <tr>
      <th>1969-05-01</th>
      <td>1394</td>
      <td>-38.0</td>
      <td>-22.0</td>
      <td>1406.615247</td>
    </tr>
    <tr>
      <th>1969-06-01</th>
      <td>1327</td>
      <td>-67.0</td>
      <td>4.0</td>
      <td>1362.732612</td>
    </tr>
  </tbody>
</table>
</div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_55_2.png" alt="png" /></p>

<p>예측 기간이 길어질수록 부정확해 질 수 있음 (아래, 24개월)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'forecast'</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dynamic</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>  
<span class="n">df</span><span class="p">[[</span><span class="s">'ridership'</span><span class="p">,</span> <span class="s">'forecast'</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/statsmodels/base/data.py:551: FutureWarning: TimeSeries is deprecated. Please use Series
  return TimeSeries(squeezed, index=self.predict_dates)





&lt;matplotlib.axes._subplots.AxesSubplot at 0x112100860&gt;
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_57_2.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">"1969-07-01"</span><span class="p">,</span> <span class="s">"</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d"</span><span class="p">)</span>
<span class="c"># &gt;1982-07-01 00:00:00</span>
<span class="n">date_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">)]</span>
<span class="c">#&gt; 1982/7/1,8/1, ... 1983/6/1</span>

<span class="n">future_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">date_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">future_df</span><span class="p">])</span> <span class="c">#concatenated  dataframe</span>
<span class="c"># print(new_df.head(),'\n...\n',new_df.tail())</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">new_df</span><span class="p">[</span><span class="s">'forecast'</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">+</span><span class="mi">11</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>  
<span class="n">new_df</span><span class="p">[[</span><span class="s">'ridership'</span><span class="p">,</span> <span class="s">'forecast'</span><span class="p">]]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="o">-</span><span class="mi">48</span><span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/Josh/anaconda/envs/venv_py35/lib/python3.5/site-packages/statsmodels/base/data.py:551: FutureWarning: TimeSeries is deprecated. Please use Series
  return TimeSeries(squeezed, index=self.predict_dates)





&lt;matplotlib.axes._subplots.AxesSubplot at 0x111b33550&gt;
</code></pre></div></div>

<p><img src="/figures-h3imdallr/timeseries_forecast_files/timeseries_forecast_59_2.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">forecast</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1968-07-01    1533.437422
1968-08-01    1507.627276
1968-09-01    1591.243235
1968-10-01    1644.424477
1968-11-01    1661.629774
1968-12-01    1615.434831
1969-01-01    1708.999117
1969-02-01    1730.117397
1969-03-01    1697.643239
1969-04-01    1719.164343
1969-05-01    1693.700319
1969-06-01    1665.040104
Freq: MS, Name: forecast, dtype: float64
</code></pre></div></div>

<h2 id="further-study">Further Study</h2>
<ul>
  <li><a href="https://www.datascienceschool.net/view-notebook/8c4f6ad9487149ca872374bbbf098e5f/">Seasonal ARIMA 다른 예제</a></li>
  <li><a href="https://www.datascienceschool.net/view-notebook/3e70dc86adb841b58736522c491eb770/">ARIMAX</a></li>
  <li><a href="http://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/">LSTM을 이용한 시계열 추정</a></li>
  <li>anomaly detection 예제</li>
  <li><a href="http://multithreaded.stitchfix.com/blog/2016/04/21/forget-arima/">Bayesian Time Series Forecasting</a></li>
</ul>

<p>(End of Doc)</p>


  <!-- Disqus -->
  

</div>


    <!-- Documents about icons are here: http://fontawesome.io/icons/ -->
<div class="footer">
  <hr />
  <div class="footer-link">
    
	
	
	
	

    

    
    <a href="https://github.com/h3imdallr"><i class="fa fa-github" aria-hidden="true"></i></a>
    
	
	
	
	

    
    <a href="https://www.linkedin.com/in/joshjung"><i class="fa fa-linkedin" aria-hidden="true"></i></a>
    
	
	
	
	
	
	
	
	

    

    

    

  </div>
  © 2017 h3imdallr. All rights reserved.
</div>

  </div>
</body>
</html>
